name: Backend CI/CD Pipeline
on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      OWNER_NAME: ${{ github.repository_owner }}
      REPO_NAME: backend
      BRANCH: ${{ github.ref_name }}
      
      # Secrets
      GITHUB_PAT: ${{ secrets.PAT_GITHUB }}
      DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASS: ${{ secrets.DOCKER_PASSWORD }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          path: app

      - name: Checkout devops repo
        run: |
          git clone -q https://${GITHUB_PAT}@github.com/${OWNER_NAME}/devops.git devops
          cd devops
          git checkout -q main

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Get short commit SHA and determine tags
        id: vars
        run: |
          cd app
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          
          # Logic from runner workflow
          if [ "${BRANCH}" = "main" ]; then
            echo "env_tag=prod" >> $GITHUB_OUTPUT
            echo "moving_tag=latest" >> $GITHUB_OUTPUT
          elif [ "${BRANCH}" = "dev" ]; then
            echo "env_tag=dev" >> $GITHUB_OUTPUT
            echo "moving_tag=dev" >> $GITHUB_OUTPUT
          else
            echo "env_tag=${BRANCH}" >> $GITHUB_OUTPUT
            echo "moving_tag=${BRANCH}" >> $GITHUB_OUTPUT
          fi

      - name: Copy SonarCloud properties
        run: |
          if [ -f "devops/${REPO_NAME}/sonar-project.properties" ]; then
            cp devops/${REPO_NAME}/sonar-project.properties app/sonar-project.properties
          fi

      # --- PR Validation Steps ---
      - name: Install Dependencies (PR)
        if: github.event_name == 'pull_request'
        run: |
          cd app
          npm ci

      - name: Run Tests (PR)
        if: github.event_name == 'pull_request'
        run: |
          cd app
          npm test

      - name: Build Project (PR)
        if: github.event_name == 'pull_request'
        run: |
          cd app
          npm run build

      # --- Deployment Steps (Push Only) ---
      - name: Execute build script
        if: github.event_name == 'push'
        env:
          COMMIT_TAG: ${{ steps.vars.outputs.sha_short }}
          ENV_TAG: ${{ steps.vars.outputs.env_tag }}
          MOVING_TAG: ${{ steps.vars.outputs.moving_tag }}
        run: |
          cd devops/${REPO_NAME}
          chmod +x build.sh
          bash build.sh

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v5.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: app

      - name: Send Discord notification on success
        if: success()
        run: |
          COMMIT_SHA="${{ steps.vars.outputs.sha_short }}"
          ENV_TAG="${{ steps.vars.outputs.env_tag }}"
          
          curl -X POST "${DISCORD_WEBHOOK_URL}" \
            -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"✅ Build Successful\",
                \"color\": 3066993,
                \"fields\": [
                  {\"name\": \"Repository\", \"value\": \"${REPO_NAME}\", \"inline\": true},
                  {\"name\": \"Branch\", \"value\": \"${BRANCH}\", \"inline\": true},
                  {\"name\": \"Commit\", \"value\": \"${COMMIT_SHA}\", \"inline\": true},
                  {\"name\": \"Environment\", \"value\": \"${ENV_TAG}\", \"inline\": true},
                  {\"name\": \"Status\", \"value\": \"No errors detected\", \"inline\": false}
                ]
              }]
            }"

      - name: Send Discord notification on failure
        if: failure()
        run: |
          COMMIT_SHA="${{ steps.vars.outputs.sha_short }}"
          ENV_TAG="${{ steps.vars.outputs.env_tag }}"
          
          curl -X POST "${DISCORD_WEBHOOK_URL}" \
            -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"❌ Build Failed\",
                \"color\": 15158332,
                \"fields\": [
                  {\"name\": \"Repository\", \"value\": \"${REPO_NAME}\", \"inline\": true},
                  {\"name\": \"Branch\", \"value\": \"${BRANCH}\", \"inline\": true},
                  {\"name\": \"Commit\", \"value\": \"${COMMIT_SHA}\", \"inline\": true},
                  {\"name\": \"Environment\", \"value\": \"${ENV_TAG}\", \"inline\": true}
                ]
              }]
            }"
